# Import NJS module
js_import /etc/nginx/njs/aiproxy.js;

js_var $ai_proxy_config "";
js_var $ai_proxy_response_prompt_tokens "";
js_var $ai_proxy_response_completion_tokens "";
js_var $ai_proxy_response_total_tokens "";

upstream creative_agent { server creative-agent:80; }
upstream fun_agent { server fun-agent:80; }
upstream supervisor { server supervisor:80; }

server {
    listen 80;
    
    js_set $ai_proxy_config aiproxy.load_rbac;
    
    # Calculate Rewritten Body via NJS
    js_set $rewritten_body aiproxy.rewriteBody;
    
    set $complexity_flag $http_x_complexity_marker;

    location /v1/chat/completions {
        # Proxy directly to OpenAI
        proxy_pass https://api.openai.com;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        
        include /etc/nginx-ai-proxy/keys/openai-key.conf;
        
        proxy_set_header Content-Type "application/json";
        proxy_pass_header Authorization;
        proxy_set_header Connection "";
        proxy_set_header Host api.openai.com;
        
        # KEY DIRECTIVE: Rewrite the Body using NJS variable
        proxy_set_body $rewritten_body;
    }

    location /agent/creative/ {
        proxy_pass http://creative_agent/;
    }

    location /agent/fun/ {
        proxy_pass http://fun_agent/;
    }

    location /supervisor/ {
        proxy_pass http://supervisor/;
    }
}
